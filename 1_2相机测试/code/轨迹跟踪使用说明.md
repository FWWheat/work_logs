# 白色物体实时轨迹跟踪功能使用说明

## 功能介绍

本功能实现了白色物体的实时检测和运动轨迹绘制，主要特性包括：

1. **白色物体检测** - 使用HSV颜色空间阈值检测白色物体
2. **多目标跟踪** - 支持同时跟踪多个白色物体
3. **轨迹绘制** - 实时绘制每个物体的运动轨迹
4. **坐标标注** - 显示物体在坐标系中的位置
5. **颜色区分** - 为不同物体分配不同的轨迹颜色
6. **渐变效果** - 轨迹具有渐变透明度，显示运动方向

## 文件说明

### 1. trajectory_tracker.py
轨迹跟踪核心模块，包含两个主要类：

- **TrajectoryTracker**: 轨迹跟踪器
  - 跟踪多个物体的运动轨迹
  - 自动匹配检测点与现有轨迹
  - 绘制彩色轨迹线和点
  
- **EnhancedImageProcessor**: 增强型图像处理器
  - 整合白色物体检测和轨迹跟踪
  - 提供完整的图像处理流程

### 2. realtime_trajectory_demo.py
实时轨迹跟踪演示程序，支持：
- ALVIUM相机实时采集
- 普通USB摄像头（备选方案）
- 实时显示和交互控制

## 使用方法

### 方式一：使用ALVIUM相机（推荐）

```bash
python realtime_trajectory_demo.py
```

### 方式二：使用电脑摄像头

```bash
python realtime_trajectory_demo.py --webcam
```

### 方式三：测试模式（不需要相机）

```bash
python trajectory_tracker.py
```

这将运行一个模拟动画，展示轨迹跟踪效果。

## 操作说明

### 键盘控制

| 按键 | 功能 |
|------|------|
| Q | 退出程序 |
| C | 清空所有轨迹 |
| 1 | 开/关坐标系显示 |
| 2 | 开/关检测结果显示 |
| 3 | 开/关轨迹显示 |
| 空格 | 暂停/继续 |

### 显示信息

程序左上角显示实时信息：
- **FPS**: 当前帧率
- **Frames**: 已处理的总帧数
- **Objects**: 当前跟踪的物体数量
- **Source**: 图像来源（相机或摄像头）

程序底部显示功能状态：
- **Coordinate**: 坐标系显示状态
- **Detection**: 检测结果显示状态
- **Trajectory**: 轨迹显示状态

## 参数调整

### 1. 白色检测阈值调整

编辑 `config.py` 文件中的 `DetectionConfig` 类：

```python
class DetectionConfig:
    # HSV颜色空间阈值范围
    HSV_LOWER = (0, 0, 200)      # 下界: H, S, V
    HSV_UPPER = (180, 30, 255)   # 上界: H, S, V
    
    # 面积过滤阈值
    MIN_AREA = 100     # 最小面积（像素）
    MAX_AREA = 50000   # 最大面积（像素）
```

**调整建议**：
- 如果检测不到白色物体，降低 `HSV_LOWER` 的 V 值（如改为 180）
- 如果误检测太多，提高 `HSV_LOWER` 的 V 值（如改为 220）
- 调整 `HSV_UPPER` 的 S 值可以控制对"纯白"的要求

### 2. 轨迹长度调整

在创建 `EnhancedImageProcessor` 时设置：

```python
processor = EnhancedImageProcessor(max_trajectory_length=100)
```

- 增大值：轨迹更长，显示更多历史路径
- 减小值：轨迹更短，减少视觉混乱

### 3. 跟踪敏感度调整

编辑 `trajectory_tracker.py` 中的匹配距离：

```python
if closest_center and min_dist < 100:  # 最大匹配距离100像素
```

- 增大值：物体移动较快时也能保持跟踪
- 减小值：减少误匹配，但快速移动可能丢失跟踪

## 应用场景

1. **机器人视觉导航** - 跟踪白色标记物的运动轨迹
2. **物体运动分析** - 分析物体的运动路径和模式
3. **工业检测** - 监控生产线上物品的移动轨迹
4. **实验记录** - 记录实验中物体的运动路径
5. **互动装置** - 创建基于运动轨迹的互动艺术装置

## 性能优化建议

1. **降低图像分辨率** - 如果FPS过低，可以在相机配置中降低分辨率
2. **减少轨迹长度** - 减小 `max_trajectory_length` 参数
3. **关闭不需要的显示** - 按键1/2/3关闭不需要的显示项
4. **调整触发间隔** - 修改 `config.py` 中的 `TRIGGER_INTERVAL`

## 常见问题

### Q1: 无法检测到白色物体
**解决方案**：
1. 确保物体足够白（RGB值接近255, 255, 255）
2. 调整 `DetectionConfig.HSV_LOWER` 和 `HSV_UPPER` 参数
3. 检查光照条件，确保物体被充分照亮

### Q2: 轨迹跟踪不稳定
**解决方案**：
1. 确保物体移动不要太快
2. 增大 `trajectory_tracker.py` 中的匹配距离阈值
3. 调整 `min_distance` 参数减少抖动

### Q3: 多个物体轨迹混淆
**解决方案**：
1. 减小匹配距离阈值，使跟踪更严格
2. 确保物体之间有足够的间距
3. 调整面积过滤参数，确保只检测目标大小的物体

### Q4: FPS过低
**解决方案**：
1. 降低相机分辨率
2. 减少轨迹长度
3. 增大 `TRIGGER_INTERVAL` 参数
4. 关闭不需要的显示项

## 技术原理

### 1. 白色物体检测
- 将BGR图像转换到HSV颜色空间
- 使用颜色阈值创建二值掩码
- 形态学操作去除噪点
- 轮廓检测和面积过滤

### 2. 轨迹跟踪
- 最近邻匹配算法
- 为每个轨迹分配唯一ID
- 使用队列存储历史位置
- 自动创建和更新轨迹

### 3. 可视化
- 渐变透明度显示时间顺序
- 多色彩区分不同对象
- 实时坐标标注
- 信息面板显示状态

## 扩展开发

### 添加轨迹保存功能

```python
# 获取轨迹数据
trajectories = processor.tracker.get_trajectories()

# 保存到文件
import json
with open('trajectories.json', 'w') as f:
    json.dump(trajectories, f)
```

### 添加轨迹分析功能

```python
# 计算轨迹长度
def calculate_trajectory_length(trajectory):
    total_length = 0
    for i in range(len(trajectory) - 1):
        dx = trajectory[i+1][0] - trajectory[i][0]
        dy = trajectory[i+1][1] - trajectory[i][1]
        total_length += np.sqrt(dx**2 + dy**2)
    return total_length
```

### 添加轨迹速度计算

```python
# 计算即时速度
def calculate_velocity(trajectory, fps):
    if len(trajectory) < 2:
        return 0
    p1, p2 = trajectory[-2], trajectory[-1]
    distance = np.sqrt((p2[0]-p1[0])**2 + (p2[1]-p1[1])**2)
    return distance * fps  # 像素/秒
```

## 更新日志

### v1.0 (2025-12-02)
- 初始版本发布
- 实现白色物体检测
- 实现多目标轨迹跟踪
- 实现实时可视化
- 支持ALVIUM相机和普通摄像头

## 联系与反馈

如有问题或建议，请参考项目文档或联系开发团队。

---

**祝使用愉快！** 🎉

