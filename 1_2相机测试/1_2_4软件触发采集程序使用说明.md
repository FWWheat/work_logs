# ALVIUM相机实时采集与检测程序使用说明

## 目录
1. [程序简介](#程序简介)
2. [环境配置](#环境配置)
3. [程序运行](#程序运行)
4. [功能说明](#功能说明)
5. [参数调整](#参数调整)
6. [坐标系说明](#坐标系说明)
7. [常见问题](#常见问题)

---

## 程序简介

本程序基于**Vimba X Python SDK**开发，实现了ALVIUM相机的实时图像采集、坐标系绘制和白色方块检测功能。

> **重要提示**: 本程序支持 **Vimba X SDK** (vmbpy 1.2.0+)，不支持旧版Vimba SDK。如果您之前安装过旧版Vimba SDK，请改为安装Vimba X SDK。

### 主要功能
- ✅ 软件触发模式连续采集图像
- ✅ 实时绘制可配置的X-Y坐标系
- ✅ 自动检测白色方块并标注
- ✅ 显示方块中心坐标（相对于坐标系）
- ✅ 实时显示FPS和检测统计
- ✅ 图形化操作界面

### 技术栈
- Python 3.9
- **Vimba X Python SDK (vmbpy 1.2.0+)**
- OpenCV (图像处理)
- Tkinter (GUI界面)

---

## 环境配置

### 前提条件
1. **操作系统**: Windows 10/11
2. **硬件**: ALVIUM 1800 U-510c 相机
3. **连接**: USB 3.0接口
4. **软件**: Vimba X SDK（必须先安装）

### 步骤1: 安装Vimba X SDK

1. 访问 Allied Vision 官网下载 **Vimba X SDK**:
   ```
   https://www.alliedvision.com/cn/products/software/vimba-x-sdk/
   ```

2. 下载Windows版本的 **Vimba X SDK** (注意不是旧版Vimba SDK)

3. 运行安装程序，选择完整安装或 "Application Development" 模式

4. 完成安装后，确保勾选 "Install Drivers" 并完成驱动安装

5. 验证安装：
   - 打开 "Vimba X Viewer" 软件（不是Vimba Viewer）
   - 确认能检测到相机并能采集图像

**注意**: Vimba X SDK 和旧版 Vimba SDK 是两个不同的软件包，本程序只支持 Vimba X SDK。

### 步骤2: 安装Conda（推荐）

1. 下载并安装 Miniconda 或 Anaconda:
   ```
   https://docs.conda.io/en/latest/miniconda.html
   ```

2. 验证安装：
   ```bash
   conda --version
   ```

### 步骤3: 创建Python环境

使用Conda创建独立环境（推荐方式）：

```bash
# 进入code目录
cd code

# 创建conda环境
conda env create -f environment.yml

# 激活环境
conda activate alvium_camera

# 安装vmbpy（需要在安装Vimba SDK后）
pip install vmbpy
```

或者使用pip直接安装（备选方式）：

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境（Windows）
venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

### 步骤4: 验证环境

```bash
# 激活环境后，运行Python检查
python -c "import vmbpy; print('vmbpy版本:', vmbpy.__version__)"
python -c "import cv2; print('OpenCV版本:', cv2.__version__)"
```

---

## 程序运行

### 启动程序

1. 确保相机已通过USB 3.0连接到电脑
2. 确保相机后部指示灯亮起（绿色）
3. 激活conda环境：
   ```bash
   conda activate alvium_camera
   ```
4. 进入code目录并运行主程序：
   ```bash
   cd code
   python main.py
   ```

### 操作步骤

1. **启动程序后**：
   - 程序会自动检查依赖和Vimba SDK安装状态
   - GUI窗口打开，初始状态为"未连接"

2. **开始采集**：
   - 点击 "开始采集" 按钮
   - 程序会自动连接相机并配置参数
   - 开始实时显示图像流

3. **观察结果**：
   - 图像上会绘制X-Y坐标系（X轴红色，Y轴蓝色）
   - 检测到的白色方块会用绿色轮廓标注
   - 方块中心显示红色圆点和坐标
   - 底部状态栏显示FPS、检测数量和总帧数

4. **停止采集**：
   - 点击 "停止采集" 按钮
   - 相机停止采集，资源释放

5. **退出程序**：
   - 点击 "退出程序" 按钮
   - 或直接关闭窗口

---

## 功能说明

### 界面布局

```
┌─────────────────────────────────────────────────┐
│  [开始采集]  [停止采集]         [退出程序]       │
├─────────────────────────────────────────────────┤
│                                                 │
│                                                 │
│             图像显示区域                         │
│          (带坐标系和检测标注)                    │
│                                                 │
│                                                 │
├─────────────────────────────────────────────────┤
│ 状态: 采集中 | FPS: 30.0 | 检测: 3个方块 | 总帧数: 900│
└─────────────────────────────────────────────────┘
```

### 坐标系绘制

- **原点位置**: 默认在图像左上角偏移(50, 50)像素
- **X轴**: 红色箭头，向右为正方向
- **Y轴**: 蓝色箭头，向下为正方向
- **刻度**: 每100像素显示一个刻度标记
- **标签**: 显示轴名称(X、Y)和刻度值

### 白色方块检测

**检测原理**:
1. 将图像转换到HSV色彩空间
2. 使用阈值分割提取白色区域
3. 形态学操作去除噪点
4. 轮廓检测并按面积过滤
5. 计算轮廓矩得到中心坐标

**检测参数**:
- HSV阈值: H=[0,180], S=[0,30], V=[200,255]
- 面积范围: 100 - 50000 像素

**标注方式**:
- 绿色轮廓框: 标注检测到的方块边界
- 红色圆点: 标记方块中心位置
- 黄色文字: 显示中心坐标(x, y)

### 性能指标

- **帧率**: 约30 FPS（取决于触发间隔配置）
- **延迟**: < 100ms（图像采集到显示）
- **检测速度**: 实时处理，不影响帧率

---

## 参数调整

所有可配置参数位于 `code/config.py` 文件中。

### 相机参数 (CameraConfig)

```python
# 曝光时间（微秒）
EXPOSURE_TIME = 20000  # 20ms，范围: 50-100000

# 增益（dB）
GAIN = 0.0  # 范围: 0-24

# 软件触发间隔（秒）
TRIGGER_INTERVAL = 0.03  # 33fps，范围: 0.01-1.0
```

**调整建议**:
- 环境较暗: 增加曝光时间或增益
- 环境较亮: 减少曝光时间
- 需要更高帧率: 减小触发间隔（但不低于0.01）

### 坐标系参数 (CoordinateConfig)

```python
# 原点位置
ORIGIN_X = 50  # X坐标
ORIGIN_Y = 50  # Y坐标

# 坐标轴长度
AXIS_LENGTH_X = 600  # X轴长度（像素）
AXIS_LENGTH_Y = 400  # Y轴长度（像素）

# 刻度间隔
TICK_INTERVAL = 100  # 像素
```

**调整建议**:
- 根据实际检测区域调整轴长度
- 刻度间隔建议50-200像素之间

### 检测参数 (DetectionConfig)

```python
# HSV阈值（白色检测）
HSV_LOWER = (0, 0, 200)    # 下界
HSV_UPPER = (180, 30, 255)  # 上界

# 面积过滤
MIN_AREA = 100    # 最小面积（像素）
MAX_AREA = 50000  # 最大面积（像素）
```

**调整建议**:
- 检测不到白色: 降低V下界值（如180）
- 误检测太多: 提高V下界值（如220）或调整面积范围
- 检测非纯白色物体: 适当放宽S上界值

### GUI参数 (GUIConfig)

```python
# 窗口尺寸
WINDOW_WIDTH = 1200
WINDOW_HEIGHT = 900

# 更新频率
UPDATE_INTERVAL = 30  # 毫秒
```

---

## 坐标系说明

### 坐标系定义

```
        O (0,0)  →  X轴 (红色)
        ↓
        Y轴 (蓝色)
```

- **原点O**: 位于图像左上角偏移(50, 50)像素处
- **X轴**: 向右为正方向，单位：像素
- **Y轴**: 向下为正方向，单位：像素

### 坐标转换

**像素坐标 → 坐标系坐标**:
```
coord_x = pixel_x - ORIGIN_X
coord_y = pixel_y - ORIGIN_Y
```

**示例**:
- 像素坐标 (250, 150)
- 坐标系坐标 (200, 100)

### 读取坐标

程序中显示的坐标格式为 `(x, y)`，表示：
- x: 相对于原点的水平距离（像素）
- y: 相对于原点的垂直距离（像素）

---

## 常见问题

### Q1: 程序启动后提示"无法导入vmbpy模块"或"cannot import name 'VmbSystem'"

**原因**: vmbpy包未安装或Vimba X SDK未正确安装

**解决方法**:
1. 确认已安装 **Vimba X SDK** 软件（不是旧版Vimba SDK）
2. 激活conda环境: `conda activate alvium_camera`
3. 安装vmbpy: `pip install vmbpy`
4. 验证: `python -c "from vmbpy import VmbSystem; print('成功')"`
5. 如果报错，请重新安装Vimba X SDK

### Q2: 点击"开始采集"后提示"未发现任何相机"

**原因**: 相机未正确连接或驱动未安装

**解决方法**:
1. 检查USB连接（必须是USB 3.0接口）
2. 确认相机后部绿灯亮起
3. 打开设备管理器，查看是否有"Allied Vision"设备
4. 尝试使用Vimba Viewer软件测试相机连接
5. 重新安装Vimba驱动

参考：`resource/ALVIUM手册.pdf` Q1节

### Q3: 图像帧率很低或无法达到最高帧率

**原因**: USB带宽限制或触发间隔设置不当

**解决方法**:
1. 检查是否使用USB 3.0接口（不是USB 2.0）
2. 调整config.py中的TRIGGER_INTERVAL值
3. 在Vimba Viewer中检查Device Link Speed（应为450000000）
4. 调整Device Link Throughput Limit为最大值

参考：`resource/ALVIUM手册.pdf` Q2节

### Q4: 检测不到白色方块

**原因**: 检测参数不适配或光照条件问题

**解决方法**:
1. 调整相机曝光和增益，确保白色方块足够亮
2. 修改config.py中的HSV_LOWER和HSV_UPPER值
3. 降低V下界值（如从200改为180）
4. 调整面积阈值MIN_AREA和MAX_AREA
5. 使用OpenCV测试程序验证参数

**测试方法**:
```bash
cd code
python image_processor.py  # 运行测试程序
```

### Q5: 误检测太多或检测噪点

**原因**: HSV阈值范围太宽或形态学操作不够

**解决方法**:
1. 提高V下界值（如从200改为220）
2. 缩小S上界值（如从30改为20）
3. 增大MIN_AREA值以过滤小噪点
4. 增大MORPH_KERNEL_SIZE值（如从5改为7）

### Q6: 如何保存检测结果图像

**方法**: 在GUI界面按键盘截图键，或修改代码添加保存功能

**代码修改示例** (在gui_app.py的_update_image函数中):
```python
# 在处理后的图像后添加
cv2.imwrite(f"result_{self.frame_count}.jpg", processed_frame)
```

### Q7: 程序运行一段时间后变慢或卡顿

**原因**: 内存泄漏或图像队列堆积

**解决方法**:
1. 重启程序
2. 检查config.py中IMAGE_QUEUE_SIZE设置（默认10）
3. 适当增大UPDATE_INTERVAL值（降低GUI更新频率）
4. 检查系统资源占用情况

### Q8: 坐标系显示不完整或超出图像边界

**原因**: 坐标轴长度设置过大

**解决方法**:
1. 修改config.py中的AXIS_LENGTH_X和AXIS_LENGTH_Y
2. 确保: ORIGIN_X + AXIS_LENGTH_X < 图像宽度
3. 确保: ORIGIN_Y + AXIS_LENGTH_Y < 图像高度

### Q9: 如何修改触发模式为硬件触发

**方法**: 修改config.py中的相机参数

```python
# 修改为硬件触发
TRIGGER_SOURCE = "Line0"  # 外部触发线
TRIGGER_MODE = "On"
```

参考：`resource/ALVIUM手册.pdf` 2.10.3节

### Q10: 如何将坐标数据导出到文件

**方法**: 修改camera_controller.py添加数据记录功能

**代码示例**:
```python
# 在_frame_callback函数中添加
with open('coordinates.txt', 'a') as f:
    for center in centers:
        coord = self.pixel_to_coordinate(center[0], center[1])
        f.write(f"{time.time()},{coord[0]},{coord[1]}\n")
```

---

## 技术支持

### 相关文档
- Vimba SDK用户手册: 安装目录下的Documentation文件夹
- ALVIUM相机用户指南: `resource/Alvium-USB-Cameras_User-Guide.pdf`
- ALVIUM快速使用说明: `resource/ALVIUM手册.pdf`
- API文档: Vimba安装目录下的API手册

### 联系方式
- Allied Vision官网: https://www.alliedvision.com/cn/
- 技术支持: https://www.alliedvision.com/cn/support/

### 代码结构
```
code/
├── main.py               # 主程序入口
├── gui_app.py           # GUI应用程序
├── camera_controller.py # 相机控制模块
├── image_processor.py   # 图像处理模块
├── config.py           # 配置参数
├── environment.yml     # Conda环境配置
└── requirements.txt    # pip依赖列表
```

---

## 更新日志

### Version 1.0 (2024-12-01)
- 初始版本发布
- 实现软件触发连续采集
- 实现坐标系绘制
- 实现白色方块检测
- 实现GUI界面

---

## 许可证

本程序仅供学习和研究使用。

---

**祝使用愉快！**

